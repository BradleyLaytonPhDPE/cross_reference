<?!= include('lof-loader'); ?>
<?!= include('loader-style'); ?>

<script src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/1.10.81/pdf.js'>
</script>

<div class="loader">
  <span class="l-1"></span>
  <span class="l-2"></span>
  <span class="l-3"></span>
  <span class="l-4"></span>
  <span class="l-5"></span>
  <span class="l-6"></span>
</div>
<span>Long, complex documents can<br />take minutes to process</span>

<script>

  PDFJS.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/1.10.81/pdf.worker.js'
  page_labs = [];

  window.onload = google.script.run.withSuccessHandler(countFigures).getDocAsPDF();

  function logIt(blob) {
    const pdf = PDFJS.getDocument({ data: blob });
    return pdf.then(function (pdf) {
      const max_pages = pdf.pdfInfo.numPages,
        promise_count = [];
      for (let i = 1; i <= max_pages; i++) {
        const page = pdf.getPage(i);
        promise_count.push(page.then(function (page) {
          const text_content = page.getTextContent();
          return text_content.then(function (page) {
            return text_content
          });
        }));
      }

      // Wait for all pages and sum counts

      return Promise.all(promise_count).then(counts => counts.map(foundCount));
    });
  }

  const foundCount = c => JSON.stringify(c).split('â˜™').length - 1

  function countFigures(blob) {
    logIt(blob).then(function (count) {
      google.script.run.withSuccessHandler(restoreLabels).insertLoFNumbers(count);
    });
  }


  function restoreLabels() {
    google.script.run.withSuccessHandler(closeDialog).restoreLabels();
  }

  function closeDialog() {
    google.script.host.close();
  }
</script>