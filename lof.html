<?!= include('loader-style'); ?>

<script src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/1.10.81/pdf.js'>
</script>

<div class="loader">
  <span class="l-1"></span>
  <span class="l-2"></span>
  <span class="l-3"></span>
  <span class="l-4"></span>
  <span class="l-5"></span>
  <span class="l-6"></span>
</div>
<span>Long, complex documents can<br />take minutes to process</span>

<script>

  PDFJS.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/1.10.81/pdf.worker.js'
  page_labs = []

  window.onload = google.script.run.withSuccessHandler(countFigures).getDocAsPDF();

  function logIt(blob) {
    const pdf = PDFJS.getDocument({ data: blob })
    return pdf.then(pdf => {
      const maxPages = pdf.pdfInfo.numPages
      const pages = []
      for (let i = 1; i <= maxPages; i++) {
        const page = pdf.getPage(i)
        pages.push(page.then(page => 
         page.getTextContent().then(pageText => pageText)
        ))
      }
      return Promise.all(pages).then(counts => counts.map(foundCount))
    })
  }

  const foundCount = c => JSON.stringify(c).split('â˜™').length - 1

  function countFigures(blob) {
    logIt(blob).then(count => {
      google.script.run.withSuccessHandler(restoreLabels).insertLoFNumbers(count)
    })
  }


  function restoreLabels() {
    google.script.run.withSuccessHandler(closeDialog).restoreLabels()
  }

  function closeDialog() {
    google.script.host.close()
  }
</script>