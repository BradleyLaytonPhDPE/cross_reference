<script>

  // TODO: menu bar wrong order
  // TODO: formatting options are not correctly initialised in sidebar (text works fine)






  let tempSettings = {}
  let refCodes = []

  $(function () {
    google.script.run.withSuccessHandler(initialiseSidebar).getSettings()
  })


  // Save the current sidebar settings as document settings
  function saveProperties(button) {
    updateTempSettings()
    google.script.run.withSuccessHandler(enableButton).updateProps(tempSettings)
  }


  $('#save-defaults').on('click', function () {
    $(this).prop('disabled', true)
    updateTempSettings()
    google.script.run.withSuccessHandler(enableButton).storeDefault(tempSettings)
  })


  $('#restore-defaults').on('click', function () {
    $('#category-select').find('option').remove().end()
    google.script.run.withSuccessHandler(initialiseSidebar).restoreDefault()
  })


  $('.clone-color').on('click', function () {
    const type = $(this).closest('.main-section').attr('id')
    google.script.run.withSuccessHandler(updateColorCode(type)).cloneColor(type)
  })


  $('#delete-category').on('click', function () {
    const ref = $('#ref_code').html().substr(1)
    const currentName = tempSettings[$('#category-select').val()].name

    $(this).css('display', 'none')
    google.script.run.withSuccessHandler(revertToFirstCategory).removePair(ref)
    $('#category-select option:contains("' + currentName + '")').remove()


    refCodes = arrayMinus(refCodes, ref)
  })

  // TODO: should really put this at the top
  const arrayMinus = (arr, item) => arr.filter(a => a !== item)

  // 

  const htmlEncode = str => String(str).replace(
    /[^\w. ]/gi,
    match => '&#' + match.charCodeAt(0) + ''
    ) 


  const isDefault = labCode => ['equat', 'figur', 'table', 'fnote'].includes(labCode)

  //
  // # Update the sidebar
  //


  const typeFlexible = (a, b) => {
    switch (typeof x === 'string') {
      case 'string':              return x < y ? -1 : y > x ? 1 : 0
      case 'number': case 'bool': return x - y
      default:                    return 0
    }
  }

  // byProp can be used to sort by different types. It takes a function that will
  // retrieve the relevant sort target from something. The default function does
  // not modify the sort target
  const byProp = (getProp=a=>a, asc=true) => (a, b) => {
    const x = asc ? getProp(a) : getProp(b)
    const y = asc ? getProp(b) : getProp(a)
    return typeFlexible(x, y)
  }


  function initialiseSidebar(settings) {
    tempSettings = { ...settings }

    const nameLowercase = entry => entry[1].name.toLowerCase()

    const byNameAsc = byProp(nameLowercase)

    const inNameOrder = Object.entries(settings).sort(byNameAsc)

    inNameOrder.forEach(entry => {
      const data = entry[1]
 
      refCodes.push(data.ref.code)

      $('#category-select').append($('<option>', {
        text: data.name,
        value: data.lab.code,
        data: data.lab.code,
      }))
    })

    const firstLabCode = inNameOrder[0][1].lab.code

    $('#category-select').data('val', firstLabCode)
    updateSidebar(firstLabCode)

    $('#delete-category').css('display', isDefault(firstLabCode) ? 'none' : 'block')
  }


  function updateSidebar(labCode) {
    const setting = tempSettings[labCode]

    $('#lab_code').html('#' + setting.lab.code)
    $('#lab_text').val(setting.lab.text)
    $('#ref_code').val(setting.ref.code).html('#' + setting.ref.code)
    $('#ref_text').val(setting.ref.text)

    $('#lab').find('.preview__text').html(setting.lab.text + '1')
    $('#ref').find('.preview__text').html(setting.ref.text + '1')

    updateColor('#lab', setting.lab.color)
    updateColor('#ref', setting.ref.color)
    updateStyle(setting)
  }


  function updateTempSettings() {
    const idIsSelected = (id) => $(id).hasClass('style-button--selected') ? true : null
    const getColorValue = (id) => $(id).data('val') != undefined ? getColorHex($(id).data('val')) : null

    const labCode = $('#lab_code').html().substr(1)
    const colorCodes = $('.details').find('.color-code')
    
    tempSettings[labCode] = {
      name: getSelectedOptionText($('#category-select')),
      lab: {
        code: labCode,
        text: $('#lab_text').val(),
        isBold: idIsSelected('#lab_bold'),
        isItalic: idIsSelected('#lab_italic'),
        isUnderlined: idIsSelected('#lab_underline'),
        color: getColorValue(colorCodes[0]),
      },
      ref: {
        code: labCode.substr(0, 3),
        text: $('#ref_text').val(),
        isBold: idIsSelected('#ref_bold'),
        isItalic: idIsSelected('#ref_italic'),
        isUnderlined: idIsSelected('#ref_underline'),
        color: getColorValue(colorCodes[1]),
      }
    }

    // data property records the previous category
    $('#category-select').data('val', $('#category-select').val())
  }


  const getColorStr = colorHex => colorHex.slice(1)
  

  const isValidColor = color => /[#|^]([0-9A-f]{3}|[0-9A-f]{6})$/.test(color)


  function getColorHex(hexStr) {
    if (hexStr == null) {
      return hexStr
    }
    
    if (!isValidColor) {
      return new Error("invalid hex color")
    }

    let result = '#'
    switch (hexStr.length) {
      case 6:
        return result + hexStr
      case 3:
        return hexStr.split().reduce((acc, cur) => acc + cur + cur, result)
    }
    return new Error("hex strings must be 3 or 6 characters")
  }


  function updateColor(id, colorHex) {
    const colorStr = colorHex ? getColorStr(colorHex) : null
    const $id = $(id)

    $id.find('.preview__text')
      .css('color', colorHex)
    $id.find('.color-code')
      .val(colorStr)
      .data('val', colorStr)
    $id.find('.color-icon')
      .css({ color: colorHex, 'border-bottom-color': colorHex })
  }



  function updateStyle(setting) {
    // gives the css property and the value we want
    // when the corresponding setting (the key here) is true
    const cssProps = {
      isBold:       ['font-weight',     'bold'],
      isItalic:     ['font-style',      'italic'],
      isUnderlined: ['text-decoration', 'underline'],
    }
    const selected = 'style-button--selected'

    for (const typeCode of ['lab', 'ref']) {
      const subSetting = setting[typeCode]
      
      for (const key in subSetting) {
        if (!(key in cssProps)) {
        continue
        }
        
        let [cssProp, cssValue] = cssProps[key]
        const btn = $('#' + typeCode + '_' + cssValue)
       
        if (subSetting[key]) {
          btn.addClass(selected)
        } else {
          cssValue = 'initial'
          btn.removeClass(selected)
        }

        $('#' + typeCode).find('.preview__text').css(cssProp, cssValue)
      }
    }
  }


  function selectCategory(labCode) {
    updateSidebar(labCode) // These rely on being in the right order, which indicates a design flaw.
    updateTempSettings()

    $('#delete-category').css('display', isDefault(labCode) ? 'none' : 'block')
    $('#lab-cover').css('display', labCode === 'fnote' ? 'block' : 'none')
  }
  
  
  const getSelectedOptionText = $el => $.trim($el.children("option:selected").text())



  $('#category-select').on('focusin', function () {
    $(this).data('val', $(this).val())
  })


  $('#category-select').on('change', function () {
    selectCategory(this.value)
  })

  // FIXME: below here, temps settings are assumed wrongly to have name as key

  // TODO: name this function: what are we doing when we add category?
  $('#add-category').on('click', function () {

    const toHide = '.category__button, #category-select, #lab_code, .actions__row:not(:last-child)'
    const toShow = '#custom-category-name, #cs_lab_code, .actions__row:last-child'
    const toClear = '#custom-category-name, #lab_code, #lab_code_entry, #lab_text, #ref_code, #ref_text'

    $(toHide).css('display', 'none')
    $(toShow).css('display', 'block')
    $(toClear).val('')
    $('#ref_code').html('#')
    $('.preview__text').css({
      'color': 'unset',
      'font-weight': 'unset',
      'font-style': 'unset',
      'text-decoration': 'unset'
    }).html('&ltelement&gt')

    $('.color-button, .color-button *').css({ 'color': 'unset', 'border-bottom-color': 'unset' })
    $('.color-code').val(null).data('val', null)

    $('.style-button--selected').removeClass('style-button--selected')
  })



  //
  // # Custom screen
  //

  const getCurrentLabCode = () => ('#lab_code_entry').val()

  function revertCustomScreen() {

    const toHide = '#custom-category-name, #cs_lab_code, .actions__row:last-child'
    const toShow = '#category-select, #lab_code, .actions__row:not(:last-child)'

    $(toHide).css('display', 'none')
    $(toShow).css('display', 'block')
    $('#add-category').css('display', 'block')
    $('#set_defaults').prop('disabled', false)
  }


  function revertToFirstCategory() {
    const firstCode = $('#category-select option:first').val()

    $('#delete-category').css('display', (isDefault(firstCode)) ? 'block' : 'none')
    $('#category-select').val(firstCode)

    updateSidebar(firstCode)
  }


  const refCodeIsTaken = code => refCodes.includes(code)


  // TODO: these event listeners should be named functions
  $('#lab_code_entry').keyup(function () {
    const labCode = getCurrentLabCode()
    const refCode = labCode.substr(0, 3)

    $(this).val(labCode.toLowerCase())

    let inputLimit = 5

    if (refCodeIsTaken) {
      $('#taken').html('âš  in use').css('color', '#9c3030')
      inputLimit = 3 // don't allow typing to continue
    } else {
      $('#taken').html('5 letters min').css('color', 'gray')
    }

    $(this).attr('maxlength', inputLimit)
    $('#lab_code').html('#' + labCode)
    $('#ref_code').html('#' + refCode)
  })


  $('#custom-category-name').keyup(function () {
    $('#category-select').data('val', this.value)
  })


  //TODO: won't work at the moment due to name stuff
  $('#save-custom').on('click', function () {
    const customCode = $('#category-select').val()
    let customSettings

    $('#save-apply').prop('disabled', true)
    saveProperties('#save-apply')

    customSettings = tempSettings[customCode]

    google.script.run.storeCustom(customSettings)

    $('#category-select option:last').after($('<option>', { text: customName })) // TODO: this is wrong
    $('#category-select').val(customCode)
    revertCustomScreen()
    $('#delete-category').css('display', 'block')
  })


  $('#cancel-custom').on('click', function () {
    revertToFirstCategory()
    revertCustomScreen()
  })


  // Disable saving a custom pairing while nameless or label code too short
  // TODO: more name debt
  document.onkeyup = function (e) {
    const nameLength = $('#custom-category-name').val().length,
      labLength = $('#lab_code_entry').val().length

    $('#save-custom').prop('disabled', nameLength === 0 || labLength !== 5)
  }


  //
  // # Settings panes
  //

  //
  // ## Text content
  //


  $('#lab_text').keyup(function () {
    const val = htmlEncode($(this).val())
    $('#lab').find('.preview__text').html(val + '1')
  })


  $('#ref_text').keyup(function () {
    const val = htmlEncode($(this).val())
    $('#ref').find('.preview__text').html(val + '1')
  })


  //
  // ## Text style
  //

  $('.style-button').on('click', function () {
    $(this).toggleClass('style-button--selected')

    const category = '#' + this.id.slice(0, 3)
    const cssValueName = this.id.slice(4)

    const cssProps = {
      'bold': 'font-weight',
      'italic': 'font-style',
      'underline': 'text-decoration'
    }

    const cssValue = $(this).hasClass('style-button--selected') ? cssValueName : 'initial'

    $(category).find('.preview__text').css(cssProps[cssValueName], cssValue)
  })


  //
  // ## Color
  //

  function confirmColor(button) {
    const $colorPane = button.parent()
    const $colorText = $colorPane.prev().children('div')
    const $colorCode = $colorPane.children('.color-code')
    const colorStr = $colorCode.val() || null
    const colorHex = getColorHex(colorStr)

    $colorCode.data('val', colorStr).val(colorStr)
    $colorText.css({ 'color': colorHex, 'border-bottom-color': colorHex })

    $($colorPane.parentsUntil('.details').find('.preview__text')).css('color', colorHex)
    $colorPane.next().andSelf().hide()
  }


  const updateColorCode = type => colorHex => $('#' + type).find('.color-code').val(getColorStr(colorHex))


  function cancelColor(button) {
    const $code = button.siblings('.color-code').andSelf()
    $code.val($code.data('val'))
    button.parent().next().andSelf().hide()
  }


  $('.color-button').on('click', function () {
    $(this).nextAll('.color-hide').slice(0, 2).toggle()
    event.stopPropagation()
  })


  $('.color-code').on('keydown', function (e) {
    switch (e.keyCode) {
      case 13:
        confirmColor($(this))
      case 27:
        cancelColor($(this))
    }
  })





  $('.confirm-color').on('click', function () {
    confirmColor($(this))
  })


  $('.cancel-color').on('click', function () {
    cancelColor($(this))
    event.stopPropagation()
  })


  // Hide color pane when anything else clicked
  $(document).on('click', function (e) {
    if ($(e.target).is('.color-pane, .color-pane *, .color-button')) return
    $('.color-hide').hide()
  })

  //
  // ## Main buttons
  //


  function enableButton(button) {
    $(button).prop('disabled', false)
  }




  $('#save-apply').on('click', function () {
    $(this).prop('disabled', true)
    saveProperties()
  })


  $('#cancel').on('click', function () {
    google.script.host.close()
  })
</script>